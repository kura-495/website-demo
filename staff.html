<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Staff Registration</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script type="module" src="firebase-config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e0f7ff;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #0077b6;
    }

    .hidden {
      display: none;
    }

    .room-info {
      background-color: #0077b6;
      color: white;
      font-weight: bold;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .form-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      max-width: 400px;
      margin: auto;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .button {
      background-color: #0096c7;
      color: white;
      border: none;
      cursor: pointer;
    }

    .button:hover {
      background-color: #005f80;
    }

    #showPasswordButton {
      background-color: #f1f1f1;
      color: #0077b6;
      border: 1px solid #0077b6;
      width: auto;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 10px;
    }

    #showPasswordButton:hover {
      background-color: #cce6ff;
    }
  </style>
</head>
<body>

  <div class="form-container" id="loginContainer">
    <h1>Staff Login</h1>
    <input type="text" id="loginUsername" placeholder="Username" required />
    <input type="password" id="loginPassword" placeholder="Password" required />
    <button id="showPasswordButton">Show Password</button>
    <button class="button" id="loginBtn">Login</button>
  </div>

  <div class="hidden" id="mainContent">
    <h1>Staff Registration</h1>
    <div class="room-info" id="room-info">Fetching Room Info...</div>
    <div class="form-container">
      <form id="staffForm">
        <input type="email" id="email" placeholder="E-mail" required>
        <input type="text" id="lastname" placeholder="Last Name" required>
        <input type="text" id="firstname" placeholder="First Name" required>
        <input type="text" id="middlename" placeholder="Middle Name (Optional)">
        <input type="text" id="nameext" placeholder="Name Extension (Optional)">

        <label for="timeStatus">Select Time In/Out:</label>
        <select id="timeStatus" required>
          <option value="Time In">Time In</option>
          <option value="Time Out">Time Out</option>
        </select>

        <label for="purpose">Purpose of Visit:</label>
        <textarea id="purpose" rows="4" maxlength="500" placeholder="Enter purpose of visit (max 500 characters)" required></textarea>

        <input type="text" id="validIDNumber" placeholder="Enter Valid ID Number" required>

        <button type="button" class="button" id="submitBtn">Enter</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const loginContainer = document.getElementById("loginContainer");
    const mainContent = document.getElementById("mainContent");
    const showPasswordButton = document.getElementById("showPasswordButton");

    const passwordInput = document.getElementById("loginPassword");
    let passwordVisible = false;

    showPasswordButton.addEventListener("click", () => {
      passwordVisible = !passwordVisible;
      passwordInput.type = passwordVisible ? "text" : "password";
      showPasswordButton.textContent = passwordVisible ? "Hide Password" : "Show Password";
    });

    const db = getDatabase();

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const inputUsername = document.getElementById("loginUsername").value;
      const inputPassword = document.getElementById("loginPassword").value;

      const staffRef = ref(db, "staff");
      const snapshot = await get(staffRef);

      if (snapshot.exists()) {
        const data = snapshot.val();
        if (data.u_name === inputUsername && data.p_word === inputPassword) {
          sessionStorage.setItem("loggedIn", "true");
          loginContainer.classList.add("hidden");
          mainContent.classList.remove("hidden");
        } else {
          alert("Incorrect username or password.");
        }
      } else {
        alert("No account data found.");
      }
    });

    // Show room info
    const roomName = localStorage.getItem("scannedRoom");
    const floorName = localStorage.getItem("scannedFloor");
    const roomInfo = document.getElementById("room-info");
    roomInfo.innerText = roomName ? `You are in: ${roomName} on the ${floorName}` : "Room info not found";

    function getPHTTimestamp() {
      return new Date().toISOString().replace("Z", "+08:00");
    }

    document.getElementById("submitBtn").addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const lastname = document.getElementById("lastname").value;
      const firstname = document.getElementById("firstname").value;
      const middlename = document.getElementById("middlename").value;
      const nameext = document.getElementById("nameext").value;
      const timeStatus = document.getElementById("timeStatus").value;
      const purpose = document.getElementById("purpose").value;
      const validIDNumber = document.getElementById("validIDNumber").value;

      if (!email || !lastname || !firstname || !validIDNumber) {
        alert("Please fill in all required fields.");
        return;
      }

      const dbRef = ref(db, "staff_log");
      push(dbRef, {
        email, lastname, firstname, middlename, nameext,
        room: roomName, floor: floorName, timeStatus, purpose,
        validIDNumber, timestamp: getPHTTimestamp()
      });

      alert("Entry submitted successfully!");
      document.getElementById("staffForm").reset();
    });

    // Auto logout
    window.addEventListener("beforeunload", () => {
      sessionStorage.removeItem("loggedIn");
    });

    // Redirect if not logged in
    if (sessionStorage.getItem("loggedIn") !== "true") {
      loginContainer.classList.remove("hidden");
      mainContent.classList.add("hidden");
    }
  </script>
</body>
</html>
