<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QRLog Registration</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script type="module" src="firebase-config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #e0f7ff;
      text-align: center;
    }

    .loader {
      margin-top: 50px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #0096c7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .room-info {
      font-size: 18px;
      margin: 20px 0;
      color: #ffffff;
      font-weight: bold;
      background-color: #0077b6;
      padding: 10px;
      border-radius: 5px;
      width: 100%;
      max-width: 400px;
    }

    .form-container {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 400px;
      margin-bottom: 40px;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    .button {
      background-color: #0096c7;
      color: white;
      font-size: 18px;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    .button:hover {
      background-color: #005f80;
    }

    .file-input {
      border: none;
      background: none;
    }

    #filePreview {
      display: none;
      max-width: 150px;
      border-radius: 10px;
      margin: 10px auto;
    }

    .view-file-btn {
      display: none;
      background-color: #4940f9;
      padding: 8px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .view-file-btn:hover {
      background-color: #413d9b;
    }

    .progress-container {
      width: 100%;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
      display: none;
    }

    .progress-bar {
      width: 0%;
      height: 10px;
      background-color: #00d9ff;
      transition: width 0.1s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="loader" id="loader"></div>
  <div class="room-info" id="room-info" style="display: none;">Fetching Room Info...</div>

  <div class="form-container" id="formContainer">
    <h2>Registration Form</h2>
    <form id="registrationForm">
      <input type="email" id="email" placeholder="E-mail" required>
      <input type="text" id="lastname" placeholder="Last Name" required>
      <input type="text" id="firstname" placeholder="First Name" required>
      <input type="text" id="middlename" placeholder="Middle Name (Optional)">
      <input type="text" id="nameext" placeholder="Name Extension (Optional)">

      <label for="timeStatus">Select Time In/Out:</label>
      <select id="timeStatus" required>
        <option value="Time In">Time In</option>
        <option value="Time Out">Time Out</option>
      </select>

      <label for="purpose">Purpose of Visit:</label>
      <select id="purpose" required>
        <option value="Training">Training</option>
        <option value="Assessment">Assessment</option>
      </select>

      <label class="file-label" for="validID">Upload a clear image of your Valid ID:</label>
      <input type="file" id="validID" class="file-input" accept="image/*" required>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <img id="filePreview"/>
      <button class="button view-file-btn" id="viewFileBtn">View Uploaded File</button>
      <button type="button" class="button" id="submitBtn">Submit</button>
    </form>
  </div>

  <script type="module">
    import { app, db } from "./firebase-config.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const loader = document.getElementById("loader");
    const roomInfoDiv = document.getElementById("room-info");
    const formContainer = document.getElementById("formContainer");

    const roomName = localStorage.getItem("scannedRoom");
    const floorName = localStorage.getItem("scannedFloor");

    setTimeout(() => {
      loader.style.display = "none";
      roomInfoDiv.style.display = "block";
      formContainer.style.display = "block";

      roomInfoDiv.innerText = roomName && floorName
        ? `You are in: ${roomName} on the ${floorName}`
        : "Room information not found";
    }, 1500);

    function getPHTTimestamp() {
      return new Date().toISOString().replace("Z", "+08:00");
    }

    const fileInput = document.getElementById("validID");
    const filePreview = document.getElementById("filePreview");
    const viewFileBtn = document.getElementById("viewFileBtn");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    let fileBase64 = "";

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();

        reader.onprogress = function(event) {
          if (event.lengthComputable) {
            const percentLoaded = Math.round((event.loaded / event.total) * 100);
            progressContainer.style.display = "block";
            progressBar.style.width = percentLoaded + "%";
          }
        };

        reader.onloadstart = function() {
          progressContainer.style.display = "block";
          progressBar.style.width = "0%";
        };

        reader.onload = function(event) {
          fileBase64 = event.target.result;
          filePreview.src = fileBase64;
          filePreview.style.display = "block";
          viewFileBtn.style.display = "block";
          progressBar.style.width = "100%";

          setTimeout(() => {
            progressContainer.style.display = "none";
          }, 500);
        };

        reader.readAsDataURL(file);
      } else {
        filePreview.style.display = "none";
        viewFileBtn.style.display = "none";
        progressContainer.style.display = "none";
        fileBase64 = "";
      }
    });

    viewFileBtn.addEventListener("click", (e) => {
      e.preventDefault();
      if (fileBase64) {
        const newTab = window.open();
        newTab.document.write(`<img src="${fileBase64}" width="100%">`);
      }
    });

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const lastname = document.getElementById("lastname").value.trim();
      const firstname = document.getElementById("firstname").value.trim();
      const middlename = document.getElementById("middlename").value.trim();
      const nameext = document.getElementById("nameext").value.trim();
      const timeStatus = document.getElementById("timeStatus").value;
      const purpose = document.getElementById("purpose").value;

      if (!email || !lastname || !firstname || !fileBase64) {
        alert("Please fill in all required fields and upload your Valid ID.");
        return;
      }

      const dbRef = ref(getDatabase(), purpose.toLowerCase());
      push(dbRef, {
        email, lastname, firstname, middlename, nameext,
        room: roomName, floor: floorName,
        timeStatus, purpose,
        validID: fileBase64,
        timestamp: getPHTTimestamp()
      });

      alert("Entry submitted successfully!");
      document.getElementById("registrationForm").reset();
      filePreview.style.display = "none";
      viewFileBtn.style.display = "none";
      fileBase64 = "";
    });
  </script>
</body>
</html>
