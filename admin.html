<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>J</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script type="module" src="firebase-config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e0f7ff;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #0077b6;
    }

    .hidden {
      display: none;
    }

    .form-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      max-width: 400px;
      margin: auto;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .button {
      background-color: #0096c7;
      color: white;
      border: none;
      cursor: pointer;
    }

    .button:hover {
      background-color: #005f80;
    }

    #showPasswordButton {
      background-color: #f1f1f1;
      color: #0077b6;
      border: 1px solid #0077b6;
      width: auto;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 10px;
    }

    #showPasswordButton:hover {
      background-color: #cce6ff;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .record {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: left;
      max-width: 800px;
      margin: 10px auto;
    }

    .record img {
      max-width: 100px;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- Login Section -->
  <div class="form-container" id="loginSection">
    <h1>Admin Login</h1>
    <input type="text" id="username" placeholder="Username" required />
    <input type="password" id="password" placeholder="Password" required />
    <button id="showPasswordButton">Show Password</button>
    <button class="button" onclick="login()">Login</button>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection" style="display: none;">
    <h1>Admin Dashboard</h1>

    <div class="filters">
      <select id="userTypeFilter">
        <option value="all">All Users</option>
        <option value="staff">Staff</option>
        <option value="student">Student</option>
        <option value="guest">Guest</option>
      </select>

      <select id="timeStatusFilter">
        <option value="all">All Status</option>
        <option value="Time In">Time In</option>
        <option value="Time Out">Time Out</option>
      </select>

      <select id="yearFilter">
        <option value="all">All Years</option>
        <!-- Year options will be populated dynamically -->
      </select>

      <select id="monthFilter" disabled>
        <option value="all">All Months</option>
        <!-- Month options will be populated dynamically -->
      </select>

      <button id="todayButton" class="button">Today</button>
      <button id="allButton" class="button">All</button>

      <select id="floorFilter">
        <option value="all">All Floors</option>
        <option value="1">Floor 1</option>
        <option value="2">Floor 2</option>
      </select>
    </div>

    <div id="recordsContainer"></div>
  </div>

 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { firebaseConfig } from './firebase-config.js';

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userTypeFilter = document.getElementById('userTypeFilter');
const timeStatusFilter = document.getElementById('timeStatusFilter');
const yearFilter = document.getElementById('yearFilter');
const monthFilter = document.getElementById('monthFilter');
const floorFilter = document.getElementById('floorFilter');
const todayButton = document.getElementById('todayButton');
const allButton = document.getElementById('allButton');
const recordsContainer = document.getElementById('records');

let forceToday = false;

userTypeFilter.addEventListener('change', fetchData);
timeStatusFilter.addEventListener('change', fetchData);
floorFilter.addEventListener('change', fetchData);

yearFilter.addEventListener('change', () => {
  if (yearFilter.value === 'all') {
    monthFilter.disabled = true;
    monthFilter.value = 'all';
  } else {
    monthFilter.disabled = false;
  }
  fetchData();
});

monthFilter.addEventListener('change', fetchData);

todayButton.addEventListener('click', () => {
  forceToday = true;
  yearFilter.disabled = true;
  monthFilter.disabled = true;
  fetchData();
});

allButton.addEventListener('click', () => {
  forceToday = false;
  yearFilter.disabled = false;
  yearFilter.value = 'all';
  monthFilter.disabled = true;
  monthFilter.value = 'all';
  fetchData();
});

async function fetchData() {
  recordsContainer.innerHTML = '';

  const selectedUser = userTypeFilter.value;
  const selectedStatus = timeStatusFilter.value;
  const selectedYear = yearFilter.value;
  const selectedMonth = monthFilter.value;
  const selectedFloor = floorFilter.value;

  const dbRef = ref(db);
  const snapshot = await get(dbRef);

  if (!snapshot.exists()) return;

  const data = snapshot.val();
  const allEntries = [];

  const types = selectedUser === 'all' ? ['staff', 'student', 'guest'] : [selectedUser];

  types.forEach(type => {
    if (data[type]) {
      Object.values(data[type]).forEach(entry => {
        allEntries.push({ ...entry, type });
      });
    }
  });

  // Populate Year Filter
  const years = [...new Set(allEntries.map(e => new Date(e.timestamp).getFullYear()))].sort();
  yearFilter.innerHTML = '<option value="all">All Years</option>';
  years.forEach(y => {
    const option = document.createElement('option');
    option.value = y;
    option.textContent = y;
    yearFilter.appendChild(option);
  });

  // Populate Month Filter (only if a specific year is selected)
  if (selectedYear !== 'all') {
    monthFilter.disabled = false;
    const months = [...new Set(
      allEntries
        .filter(e => new Date(e.timestamp).getFullYear() === Number(selectedYear))
        .map(e => new Date(e.timestamp).getMonth() + 1)
    )].sort((a, b) => a - b);

    monthFilter.innerHTML = '<option value="all">All Months</option>';
    months.forEach(m => {
      const option = document.createElement('option');
      option.value = m;
      option.textContent = m;
      monthFilter.appendChild(option);
    });
  }

  // Filter entries based on selected filters
  const today = new Date();
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
  const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime();

  allEntries.forEach(entry => {
    const timestamp = new Date(entry.timestamp).getTime();

    if (forceToday && (timestamp < todayStart || timestamp >= todayEnd)) return;

    if (selectedYear !== 'all') {
      const entryYear = new Date(entry.timestamp).getFullYear();
      if (entryYear !== Number(selectedYear)) return;
    }

    if (selectedMonth !== 'all' && selectedYear !== 'all') {
      const entryMonth = new Date(entry.timestamp).getMonth() + 1;
      if (entryMonth !== Number(selectedMonth)) return;
    }

    if (selectedStatus !== 'all' && entry.timeStatus !== selectedStatus) return;
    if (selectedFloor !== 'all' && entry.floor !== selectedFloor) return;

    const recordDiv = document.createElement('div');
    recordDiv.className = 'record';
    recordDiv.innerHTML = `
      <strong>User Type:</strong> ${entry.type}<br>
      <strong>Email:</strong> ${entry.email || 'N/A'}<br>
      <strong>Name:</strong> ${entry.firstname || ''} ${entry.middlename || ''} ${entry.lastname || ''} ${entry.nameext || ''}<br>
      <strong>Time Status:</strong> ${entry.timeStatus || 'N/A'}<br>
      <strong>Room:</strong> ${entry.room || 'N/A'}<br>
      <strong>Floor:</strong> ${entry.floor || 'N/A'}<br>
      <strong>Purpose:</strong> ${entry.purpose || 'N/A'}<br>
      <strong>Timestamp:</strong> ${new Date(entry.timestamp).toLocaleString()}<br>
      ${entry.imageData ? `<img src="${entry.imageData}" alt="ID Image" />` : ''}
    `;
    recordsContainer.appendChild(recordDiv);
  });
}

// Initial fetch
fetchData();
</script>
</body>
</html>
